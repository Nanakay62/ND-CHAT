<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d0f14">
    <title>ND Chat</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --bg: #0d0f14;
            --surface: #161920;
            --surface2: #1e2230;
            --border: rgba(255,255,255,0.07);
            --accent: #6c63ff;
            --accent2: #ff6584;
            --text: #e8eaf0;
            --text-dim: rgba(232,234,240,0.5);
            --sent-bg: linear-gradient(135deg, #6c63ff 0%, #8b5cf6 100%);
            --recv-bg: #1e2230;
            --online: #34d399;
            --danger: #f87171;
        }

        html {
            height: 100%;
            height: 100dvh;
        }

        :root {
            --app-height: 100dvh;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            height: 100%;
            height: var(--app-height, 100dvh);
            display: flex;
            color: var(--text);
            overflow: hidden;
            /* Safe area insets for notch/home bar devices */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* === SIDEBAR === */
        .sidebar {
            width: 320px;
            min-width: 320px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
        }

        .icon-btn:hover { color: var(--text); background: var(--surface2); border-color: var(--accent); }
        .icon-btn:active { transform: scale(0.93); }

        .search-box {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input::placeholder { color: var(--text-dim); }
        .search-input:focus { border-color: var(--accent); }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .contacts-list::-webkit-scrollbar { width: 4px; }
        .contacts-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .section-label {
            padding: 8px 16px 4px;
            font-size: 11px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-dim);
            font-family: 'Space Mono', monospace;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s;
            border-radius: 0;
            position: relative;
        }

        .contact-item:hover { background: var(--surface2); }
        .contact-item.active { background: rgba(108,99,255,0.12); }
        .contact-item.active::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            background: var(--accent);
            border-radius: 0 2px 2px 0;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: var(--surface2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            color: var(--text);
        }

        .avatar-initials {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .online-dot {
            position: absolute;
            bottom: 2px; right: 2px;
            width: 10px; height: 10px;
            background: var(--online);
            border-radius: 50%;
            border: 2px solid var(--surface);
        }

        .contact-info { flex: 1; min-width: 0; }

        .contact-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-preview {
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }

        .contact-time { font-size: 11px; color: var(--text-dim); }

        .unread-badge {
            background: var(--accent);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 7px;
            border-radius: 99px;
            font-family: 'Space Mono', monospace;
        }

        .me-label {
            background: rgba(108,99,255,0.2);
            color: var(--accent);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid rgba(108,99,255,0.3);
        }

        /* === MAIN CHAT === */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            background: var(--bg);
            position: relative;
            overflow: hidden;
        }

        .chat-toolbar {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            min-height: 65px;
            flex-shrink: 0;
        }

        .chat-toolbar .avatar { width: 38px; height: 38px; border-radius: 11px; }

        .toolbar-info { flex: 1; }

        .toolbar-name { font-size: 15px; font-weight: 600; }

        .toolbar-status {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 1px;
        }

        .toolbar-status.online { color: var(--online); }

        .toolbar-btn {
            width: 38px;
            height: 38px;
            border-radius: 11px;
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .toolbar-btn:hover { color: var(--text); border-color: var(--accent); }
        .toolbar-btn:active { transform: scale(0.93); }
        .toolbar-btn.call-btn:hover { color: var(--online); border-color: var(--online); }
        .toolbar-btn.end-call { color: var(--danger); border-color: var(--danger); background: rgba(248,113,113,0.1); }
        .toolbar-btn.end-call:hover { background: rgba(248,113,113,0.2); }

        /* === MESSAGES === */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .messages-area::-webkit-scrollbar { width: 4px; }
        .messages-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .msg-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            animation: msgIn 0.25s ease-out;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-row.sent { flex-direction: row-reverse; }

        .msg-row .avatar { width: 28px; height: 28px; border-radius: 9px; font-size: 11px; flex-shrink: 0; align-self: flex-end; }

        .msg-bubble {
            max-width: 68%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            word-break: break-word;
        }

        .msg-row.sent .msg-bubble {
            background: var(--sent-bg);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .msg-row.received .msg-bubble {
            background: var(--recv-bg);
            color: var(--text);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border);
        }

        .msg-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 5px;
            justify-content: flex-end;
        }

        .msg-time {
            font-size: 10px;
            opacity: 0.6;
            font-family: 'Space Mono', monospace;
        }

        .msg-expires {
            font-size: 10px;
            opacity: 0.5;
            font-family: 'Space Mono', monospace;
        }

        .msg-row.received .msg-meta { justify-content: flex-start; }

        .msg-image {
            max-width: 100%;
            max-height: 250px;
            border-radius: 12px;
            cursor: pointer;
            display: block;
            margin-bottom: 4px;
        }

        .date-divider {
            text-align: center;
            padding: 12px 0;
            font-size: 11px;
            color: var(--text-dim);
            font-family: 'Space Mono', monospace;
            letter-spacing: 0.05em;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            gap: 12px;
            padding: 40px;
            text-align: center;
        }

        .empty-icon { font-size: 48px; opacity: 0.4; }
        .empty-title { font-size: 18px; font-weight: 500; color: var(--text); }
        .empty-sub { font-size: 13px; max-width: 280px; }

        /* === INPUT === */
        .input-area {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }

        .typing-bar {
            font-size: 12px;
            color: var(--accent);
            min-height: 18px;
            margin-bottom: 8px;
            font-style: italic;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .msg-input {
            flex: 1;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 11px 16px;
            color: var(--text);
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
        }

        .msg-input::placeholder { color: var(--text-dim); }
        .msg-input:focus { border-color: rgba(108,99,255,0.4); }

        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 13px;
            border: none;
            background: var(--accent);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover { background: #5a52e0; }
        .send-btn:active { transform: scale(0.9); }

        /* === AUTH MODAL === */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(12px);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 36px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 24px 80px rgba(0,0,0,0.5);
        }

        .modal-logo {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 6px;
        }

        .modal-sub {
            text-align: center;
            font-size: 13px;
            color: var(--text-dim);
            margin-bottom: 28px;
        }

        .tabs {
            display: flex;
            background: var(--surface2);
            border-radius: 12px;
            padding: 3px;
            margin-bottom: 24px;
            gap: 3px;
        }

        .tab {
            flex: 1;
            padding: 9px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-dim);
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 6px rgba(0,0,0,0.3); }

        .form-group { margin-bottom: 14px; }

        .form-input {
            width: 100%;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 13px 16px;
            color: var(--text);
            font-size: 15px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input::placeholder { color: var(--text-dim); }
        .form-input:focus { border-color: var(--accent); }

        .submit-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: var(--accent);
            color: white;
            font-size: 15px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 4px;
        }

        .submit-btn:hover { background: #5a52e0; }
        .submit-btn:active { transform: scale(0.98); }

        .error-box {
            background: rgba(248,113,113,0.1);
            border: 1px solid rgba(248,113,113,0.3);
            color: #fca5a5;
            font-size: 13px;
            padding: 10px 14px;
            border-radius: 10px;
            margin-top: 14px;
            display: none;
        }

        .error-box.show { display: block; }

        /* === ADD CONTACT MODAL === */
        .add-contact-modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            width: 100%;
            max-width: 360px;
        }

        .add-contact-modal h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .add-contact-modal p {
            font-size: 13px;
            color: var(--text-dim);
            margin-bottom: 20px;
        }

        /* === CALL UI === */
        .call-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 24px;
        }

        .call-overlay.active { display: flex; }

        .call-avatar {
            width: 100px;
            height: 100px;
            border-radius: 28px;
            background: var(--surface2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-size: 36px;
            position: relative;
        }

        .call-avatar::before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 36px;
            border: 2px solid var(--accent);
            opacity: 0;
            animation: callPulse 1.5s ease-in-out infinite;
        }

        @keyframes callPulse {
            0%, 100% { opacity: 0; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.05); }
        }

        .call-name { font-size: 22px; font-weight: 600; }

        .call-status { font-size: 14px; color: var(--text-dim); font-family: 'Space Mono', monospace; }

        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 16px;
        }

        .call-ctrl {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.2s;
        }

        .call-ctrl:active { transform: scale(0.9); }
        .call-ctrl.mute { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
        .call-ctrl.mute.active { background: var(--danger); color: white; border-color: var(--danger); }
        .call-ctrl.hangup { background: var(--danger); color: white; }
        .call-ctrl.answer { background: var(--online); color: white; }

        .incoming-call-modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 36px;
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .incoming-call-modal .call-avatar {
            width: 80px;
            height: 80px;
            border-radius: 22px;
            margin: 0 auto 16px;
            font-size: 28px;
        }

        .incoming-title { font-size: 13px; color: var(--text-dim); margin-bottom: 6px; font-family: 'Space Mono', monospace; }
        .incoming-name { font-size: 22px; font-weight: 600; margin-bottom: 24px; }

        .incoming-btns { display: flex; justify-content: center; gap: 24px; }

        /* === NOTIFICATION === */
        .notif {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 18px;
            font-size: 13px;
            z-index: 2000;
            animation: notifIn 0.3s ease;
            max-width: 280px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        @keyframes notifIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-back { display: none; }

        /* === MOBILE === */
        @media (max-width: 700px) {
            html, body {
                height: 100%;
                height: 100dvh;
                overflow: hidden;
                padding: 0;
            }

            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }

            .sidebar {
                position: fixed;
                left: 0; top: 0; bottom: 0;
                padding-left: env(safe-area-inset-left);
                z-index: 300;
                width: 85vw;
                min-width: unset;
                max-width: 320px;
                transform: translateX(-105%);
                box-shadow: none;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
                box-shadow: 4px 0 32px rgba(0,0,0,0.5);
            }

            .sidebar-backdrop {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 299;
                backdrop-filter: blur(2px);
            }
            .sidebar-backdrop.show { display: block; }

            .chat-main {
                width: 100%;
                min-width: 0;
            }

            .mobile-back { display: flex !important; }

            .chat-toolbar {
                padding: 10px 12px;
                min-height: 56px;
            }

            .toolbar-name { font-size: 14px; }
            .toolbar-status { font-size: 11px; }

            #my-username-display {
                max-width: 70px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-size: 11px;
            }

            .messages-area {
                padding: 12px;
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .input-area {
                padding: 8px 12px;
                padding-bottom: max(12px, env(safe-area-inset-bottom));
                flex-shrink: 0;
            }

            .msg-input {
                font-size: 16px;
            }

            .msg-bubble { max-width: 82%; }

            .notif {
                bottom: max(16px, env(safe-area-inset-bottom));
                right: 12px;
                left: 12px;
                max-width: unset;
                font-size: 13px;
            }
        }

        /* === NO CHAT SELECTED === */
        .no-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            color: var(--text-dim);
            text-align: center;
            padding: 40px;
        }

        .no-chat-icon { font-size: 64px; opacity: 0.2; }
        .no-chat-title { font-size: 20px; font-weight: 500; color: var(--text); opacity: 0.5; }
        .no-chat-sub { font-size: 13px; max-width: 260px; }

        #image-input { display: none; }

        .img-preview-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .img-preview-overlay.show { display: flex; }
        .img-preview-overlay img { max-width: 95%; max-height: 95%; border-radius: 12px; }
        .img-preview-close {
            position: absolute;
            top: 16px; right: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .timer-bar {
            height: 2px;
            background: var(--accent);
            border-radius: 1px;
            margin-top: 6px;
            transition: width linear;
            opacity: 0.5;
        }

        /* === SWIPE TO REPLY === */
        .msg-row {
            position: relative;
            touch-action: pan-y;
            user-select: none;
        }

        .msg-bubble {
            transition: transform 0.15s ease;
            will-change: transform;
        }

        .reply-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%) scale(0.6);
            opacity: 0;
            transition: opacity 0.15s, transform 0.15s;
            font-size: 20px;
            pointer-events: none;
        }
        .msg-row.sent .reply-icon { left: -38px; }
        .msg-row.received .reply-icon { right: -38px; }
        .reply-icon.show {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }

        /* === REPLY PREVIEW BAR === */
        .reply-preview {
            display: none;
            background: var(--surface2);
            border-left: 3px solid var(--accent);
            border-radius: 10px 10px 0 0;
            padding: 8px 12px;
            margin-bottom: 6px;
            font-size: 12px;
            color: var(--text-dim);
            position: relative;
            animation: msgIn 0.2s ease;
        }
        .reply-preview.show { display: flex; align-items: flex-start; gap: 8px; }
        .reply-preview-text {
            flex: 1;
            overflow: hidden;
        }
        .reply-preview-label {
            font-size: 11px;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 2px;
            font-family: 'Space Mono', monospace;
        }
        .reply-preview-body {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
            font-size: 13px;
        }
        .reply-cancel {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0 2px;
            flex-shrink: 0;
        }
        .reply-cancel:hover { color: var(--text); }

        /* === QUOTED REPLY IN MESSAGE === */
        .msg-quote {
            background: rgba(255,255,255,0.07);
            border-left: 3px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 6px 10px;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .msg-row.sent .msg-quote { border-left-color: rgba(255,255,255,0.5); }
        .msg-quote-author { font-weight: 600; color: rgba(255,255,255,0.8); margin-bottom: 2px; font-size: 11px; }
        .msg-quote-text { color: rgba(255,255,255,0.6); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* === TIMER PICKER === */
        .timer-picker {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0 6px;
        }
        .timer-label {
            font-size: 11px;
            color: var(--text-dim);
            white-space: nowrap;
            font-family: 'Space Mono', monospace;
        }
        .timer-chips {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .timer-chip {
            padding: 4px 10px;
            border-radius: 99px;
            border: 1px solid var(--border);
            background: var(--surface2);
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .timer-chip:hover { border-color: var(--accent); color: var(--text); }
        .timer-chip.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* === CONTACT DELETE === */
        .contact-item {
            overflow: hidden;
        }
        .contact-delete-btn {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 9px;
            border: 1px solid rgba(248,113,113,0.3);
            background: rgba(248,113,113,0.1);
            color: var(--danger);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
            margin-left: auto;
        }
        .contact-delete-btn:hover { background: rgba(248,113,113,0.25); }
        .contact-item:hover .contact-delete-btn { display: flex; }

        /* Confirm delete dialog */
        .confirm-modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            width: 100%;
            max-width: 340px;
            text-align: center;
        }
        .confirm-modal h3 { font-size: 18px; margin-bottom: 8px; }
        .confirm-modal p { font-size: 13px; color: var(--text-dim); margin-bottom: 24px; }
        .confirm-btns { display: flex; gap: 10px; }
        .confirm-btns button { flex: 1; padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-size: 14px; font-family: 'DM Sans', sans-serif; font-weight: 500; transition: all 0.2s; }
        .btn-cancel-del { background: var(--surface2); color: var(--text); border: 1px solid var(--border) !important; }
        .btn-confirm-del { background: var(--danger); color: white; }
        .btn-confirm-del:hover { background: #ef4444; }

        audio { display: none; }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo">ND Chat</div>
        <div class="sidebar-actions">
            <button class="icon-btn" id="add-contact-btn" title="Add contact">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
            </button>
            <button class="icon-btn" id="logout-btn" title="Logout">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </button>
        </div>
    </div>
    <div class="search-box">
        <input type="text" class="search-input" id="search-contacts" placeholder="Search contacts...">
    </div>
    <div class="contacts-list" id="contacts-list">
        <div style="padding:20px;text-align:center;color:var(--text-dim);font-size:13px">No contacts yet.<br>Add contacts to start chatting.</div>
    </div>
</div>

<!-- MAIN CHAT -->
<div class="chat-main" id="chat-main">
    <div class="chat-toolbar" id="chat-toolbar">
        <button class="toolbar-btn mobile-back" id="mobile-back">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="avatar" id="toolbar-avatar" style="display:none"><span class="avatar-initials" id="toolbar-initials"></span></div>
        <div class="toolbar-info" id="toolbar-info" style="display:none">
            <div class="toolbar-name" id="toolbar-name"></div>
            <div class="toolbar-status" id="toolbar-status">offline</div>
        </div>
        <button class="toolbar-btn call-btn" id="call-btn" style="display:none" title="Voice call">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.4 2 2 0 0 1 3.6 1.22h3a2 2 0 0 1 2 1.72c.127.96.36 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.78a16 16 0 0 0 6.29 6.29l.97-.97a2 2 0 0 1 2.11-.45c.907.34 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
        </button>
        <div style="flex:1" id="toolbar-empty">
            <span style="font-size:15px;font-weight:500;color:var(--text-dim)">Select a conversation</span>
        </div>
        <div style="margin-left:auto">
            <span style="font-size:12px;color:var(--text-dim);font-family:'Space Mono',monospace" id="my-username-display"></span>
        </div>
    </div>

    <div id="main-content" class="no-chat">
        <div class="no-chat-icon">üí¨</div>
        <div class="no-chat-title">No conversation selected</div>
        <div class="no-chat-sub">Choose a contact from the sidebar to start a private chat</div>
    </div>

    <div id="messages-area" class="messages-area" style="display:none"></div>

    <div class="input-area" id="input-area" style="display:none">
        <!-- Reply preview bar -->
        <div class="reply-preview" id="reply-preview">
            <div class="reply-preview-text">
                <div class="reply-preview-label" id="reply-preview-label">Replying to</div>
                <div class="reply-preview-body" id="reply-preview-body"></div>
            </div>
            <button class="reply-cancel" id="reply-cancel" title="Cancel reply">√ó</button>
        </div>
        <!-- Timer picker -->
        <div class="timer-picker">
            <span class="timer-label">‚è±</span>
            <div class="timer-chips" id="timer-chips">
                <button class="timer-chip active" data-mins="5">5m</button>
                <button class="timer-chip" data-mins="10">10m</button>
                <button class="timer-chip" data-mins="15">15m</button>
                <button class="timer-chip" data-mins="20">20m</button>
                <button class="timer-chip" data-mins="30">30m</button>
            </div>
        </div>
        <div class="typing-bar" id="typing-bar"></div>
        <div class="input-row">
            <button class="icon-btn" id="attach-btn" title="Send image">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </button>
            <input type="file" id="image-input" accept="image/*">
            <input type="text" class="msg-input" id="message-input" placeholder="Message..." autocomplete="off">
            <button class="send-btn" id="send-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>
</div>

<!-- AUTH MODAL -->
<div class="overlay" id="auth-overlay">
    <div class="modal">
        <div class="modal-logo">ND Chat</div>
        <div class="modal-sub">Private, ephemeral messaging</div>
        <div class="tabs">
            <button class="tab active" id="login-tab">Login</button>
            <button class="tab" id="signup-tab">Sign Up</button>
        </div>
        <div id="login-form">
            <div class="form-group"><input type="email" class="form-input" id="login-email" placeholder="Email"></div>
            <div class="form-group"><input type="password" class="form-input" id="login-password" placeholder="Password"></div>
            <button class="submit-btn" id="login-btn">Login</button>
        </div>
        <div id="signup-form" style="display:none">
            <div class="form-group"><input type="text" class="form-input" id="signup-username" placeholder="Username" maxlength="20"></div>
            <div class="form-group"><input type="email" class="form-input" id="signup-email" placeholder="Email"></div>
            <div class="form-group"><input type="password" class="form-input" id="signup-password" placeholder="Password (min 6 chars)"></div>
            <button class="submit-btn" id="signup-btn">Create Account</button>
        </div>
        <div class="error-box" id="auth-error"></div>
    </div>
</div>

<!-- ADD CONTACT MODAL -->
<div class="overlay" id="add-contact-overlay" style="display:none">
    <div class="add-contact-modal">
        <h3>Add Contact</h3>
        <p>Search by <b id="search-mode-label" style="color:var(--accent)">username</b> or switch to email.</p>
        <div style="display:flex;background:var(--surface2);border-radius:10px;padding:3px;margin-bottom:14px;gap:3px">
            <button class="tab active" id="mode-username" style="flex:1;padding:8px;border:none;border-radius:8px;cursor:pointer;font-family:inherit;font-size:13px;background:var(--surface);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.3)">Username</button>
            <button class="tab" id="mode-email" style="flex:1;padding:8px;border:none;border-radius:8px;cursor:pointer;font-family:inherit;font-size:13px;background:transparent;color:var(--text-dim)">Email</button>
        </div>
        <div class="form-group">
            <input type="text" class="form-input" id="contact-username-input" placeholder="@username">
            <input type="email" class="form-input" id="contact-email-input" placeholder="friend@email.com" style="display:none">
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
            <button class="submit-btn" style="background:var(--surface2);color:var(--text);border:1px solid var(--border)" id="cancel-add-contact">Cancel</button>
            <button class="submit-btn" id="confirm-add-contact">Add Contact</button>
        </div>
        <div class="error-box" id="contact-error"></div>
    </div>
</div>

<!-- CALL UI -->
<div class="call-overlay" id="call-overlay">
    <div class="call-avatar" id="call-avatar"><span id="call-initials"></span></div>
    <div class="call-name" id="call-name"></div>
    <div class="call-status" id="call-status">Calling...</div>
    <div class="call-controls">
        <button class="call-ctrl mute" id="mute-btn" title="Mute">üé§</button>
        <button class="call-ctrl hangup" id="hangup-btn">üìµ</button>
    </div>
</div>

<!-- INCOMING CALL -->
<div class="overlay" id="incoming-overlay" style="display:none">
    <div class="incoming-call-modal">
        <div class="call-avatar" style="width:80px;height:80px;border-radius:22px;margin:0 auto 16px">
            <span id="incoming-initials" style="font-size:28px;font-family:'Space Mono',monospace"></span>
        </div>
        <div class="incoming-title">Incoming voice call</div>
        <div class="incoming-name" id="incoming-name"></div>
        <div class="incoming-btns">
            <button class="call-ctrl hangup" id="decline-btn">üìµ</button>
            <button class="call-ctrl answer" id="answer-btn">üìû</button>
        </div>
    </div>
</div>

<!-- IMAGE PREVIEW -->
<div class="img-preview-overlay" id="img-preview">
    <button class="img-preview-close" id="img-preview-close">‚úï Close</button>
    <img id="img-preview-src" src="" alt="">
</div>

<audio id="remote-audio" autoplay></audio>
<audio id="ring-audio" loop>
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFb" type="audio/wav">
</audio>


<!-- CONFIRM DELETE CONTACT MODAL -->
<div class="overlay" id="confirm-delete-overlay" style="display:none">
    <div class="confirm-modal">
        <h3>Remove Contact</h3>
        <p id="confirm-delete-text">Are you sure you want to remove this contact?</p>
        <div class="confirm-btns">
            <button class="btn-cancel-del" id="confirm-delete-cancel">Cancel</button>
            <button class="btn-confirm-del" id="confirm-delete-ok">Remove</button>
        </div>
    </div>
</div>

<!-- LOGOUT CONFIRM MODAL -->
<div class="overlay" id="logout-overlay" style="display:none">
    <div class="confirm-modal">
        <h3>Log Out</h3>
        <p>Are you sure you want to log out of Nana Dickson's Chat?</p>
        <div class="confirm-btns">
            <button class="btn-cancel-del" id="logout-cancel">Stay</button>
            <button class="btn-confirm-del" style="background:var(--accent)" id="logout-confirm">Log Out</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyALRm6h7k5hHZwwX6YkEPfxQ2HRFFsF99g",
    authDomain: "nd-chat-app-d2f3d.firebaseapp.com",
    databaseURL: "https://nd-chat-app-d2f3d-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "nd-chat-app-d2f3d",
    storageBucket: "nd-chat-app-d2f3d.firebasestorage.app",
    messagingSenderId: "846998717299",
    appId: "1:846998717299:web:c0b616ecfe946bae05fb06"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// TTL is now per-message (selectedTTL), default 5 min

let currentUser = null, myUsername = '', myUid = '';
let activeContactUid = null, activeContactName = '';
let msgListeners = {};
let typingTimeout = null;
let contactsData = {}; // uid -> {username, email, online}

// Timer & reply state
let selectedTTL = 5 * 60 * 1000; // default 5 min in ms
let replyingTo = null; // { key, senderName, text }
let pendingDeleteUid = null;

// WebRTC
let pc = null, localStream = null;
let callType = null; // 'outgoing' | 'incoming'
let callContactUid = null;
let isMuted = false;

// ===================== AUTH =====================

document.getElementById('login-tab').onclick = () => switchTab('login');
document.getElementById('signup-tab').onclick = () => switchTab('signup');

function switchTab(t) {
    document.getElementById('login-tab').classList.toggle('active', t==='login');
    document.getElementById('signup-tab').classList.toggle('active', t==='signup');
    document.getElementById('login-form').style.display = t==='login'?'block':'none';
    document.getElementById('signup-form').style.display = t==='signup'?'block':'none';
    hideAuthError();
}

document.getElementById('login-btn').onclick = async () => {
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-password').value;
    if (!email||!pass) return showAuthError('Fill all fields');
    try { await auth.signInWithEmailAndPassword(email, pass); }
    catch(e) { showAuthError(firebaseErrMsg(e.code)); }
};

document.getElementById('signup-btn').onclick = async () => {
    const uname = document.getElementById('signup-username').value.trim();
    const email = document.getElementById('signup-email').value.trim().toLowerCase();
    const pass = document.getElementById('signup-password').value;
    const unameLower = uname.toLowerCase();

    if (!uname||!email||!pass) return showAuthError('Fill all fields');
    if (pass.length < 6) return showAuthError('Password must be at least 6 characters');
    if (!/^[a-zA-Z0-9_]+$/.test(uname)) return showAuthError('Username can only contain letters, numbers, and underscores');

    // Check username uniqueness (case-insensitive via lowercase index)
    const usnap = await db.ref('usernameLookup/'+unameLower).once('value');
    if (usnap.exists()) return showAuthError('That username is already taken ‚Äî try another');

    try {
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await cred.user.updateProfile({displayName: uname});
        // Write profile: always store email lowercase so search is reliable
        await db.ref('userProfiles/'+cred.user.uid).set({username: uname, usernameLower, email});
        // Write username lookup index (usernameLower -> uid) for uniqueness + search
        await db.ref('usernameLookup/'+unameLower).set(cred.user.uid);
        // Write email lookup index (email -> uid) for add-by-email
        await db.ref('emailLookup/'+email.replace(/\./g,'_')).set(cred.user.uid);
    } catch(e) { showAuthError(firebaseErrMsg(e.code)); }
};

auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        myUid = user.uid;
        myUsername = user.displayName || 'User';
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('my-username-display').textContent = myUsername;
        await initApp();
    } else {
        document.getElementById('auth-overlay').style.display = 'flex';
        cleanup();
    }
});

document.getElementById('logout-btn').onclick = () => {
    document.getElementById('logout-overlay').style.display = 'flex';
};

// ===================== INIT =====================

async function initApp() {
    // Set online presence
    const presRef = db.ref('presence/'+myUid);
    presRef.set({username: myUsername, online: true, lastSeen: firebase.database.ServerValue.TIMESTAMP});
    presRef.onDisconnect().update({online: false, lastSeen: firebase.database.ServerValue.TIMESTAMP});

    // Remove typing on disconnect
    db.ref('typing/'+myUid).onDisconnect().remove();

    loadContacts();
    listenForCalls();
}

function cleanup() {
    activeContactUid = null;
    contactsData = {};
    Object.values(msgListeners).forEach(off => off && off());
    msgListeners = {};
}

// ===================== CONTACTS =====================

function loadContacts() {
    db.ref('contacts/'+myUid).on('value', snap => {
        const contacts = snap.val() || {};
        const uids = Object.keys(contacts);

        // Clear old presence listeners
        contactsData = {};

        if (uids.length === 0) {
            renderContactsList();
            return;
        }

        let loaded = 0;
        uids.forEach(uid => {
            // Get profile
            db.ref('userProfiles/'+uid).once('value', ps => {
                const profile = ps.val() || {};
                contactsData[uid] = {username: profile.username || uid, email: profile.email || ''};
                // Listen to presence
                db.ref('presence/'+uid).on('value', psnap => {
                    const pres = psnap.val() || {};
                    if (!contactsData[uid]) contactsData[uid] = {};
                    contactsData[uid].online = !!pres.online;
                    contactsData[uid].lastSeen = pres.lastSeen;
                    renderContactsList();
                    if (uid === activeContactUid) updateToolbarStatus();
                });
                loaded++;
                if (loaded === uids.length) renderContactsList();
            });
        });
    });
}

function renderContactsList() {
    const list = document.getElementById('contacts-list');
    const search = document.getElementById('search-contacts').value.toLowerCase();
    const uids = Object.keys(contactsData).filter(uid =>
        !search || contactsData[uid].username.toLowerCase().includes(search)
    );

    if (uids.length === 0) {
        list.innerHTML = `<div style="padding:20px;text-align:center;color:var(--text-dim);font-size:13px">
            ${search ? 'No contacts match.' : 'No contacts yet.<br>Click + to add someone.'}</div>`;
        return;
    }

    list.innerHTML = '';
    uids.forEach(uid => {
        const c = contactsData[uid];
        const initials = getInitials(c.username);
        const isActive = uid === activeContactUid;
        const div = document.createElement('div');
        div.className = 'contact-item' + (isActive?' active':'');
        div.style.cssText = 'display:flex;align-items:center;gap:12px;padding:10px 16px;cursor:pointer;position:relative;';
        div.innerHTML = `
            <div class="avatar">
                <span class="avatar-initials">${initials}</span>
                ${c.online ? '<div class="online-dot"></div>' : ''}
            </div>
            <div class="contact-info">
                <div class="contact-name">${escHtml(c.username)}</div>
                <div class="contact-preview">${c.online ? '‚óè Online' : 'Offline'}</div>
            </div>
            <button class="contact-delete-btn" title="Remove contact">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
            </button>`;

        // Click on contact (not delete btn) opens chat
        div.onclick = (e) => {
            if (e.target.closest('.contact-delete-btn')) return;
            openChat(uid, c.username);
        };

        // Delete button
        div.querySelector('.contact-delete-btn').onclick = (e) => {
            e.stopPropagation();
            pendingDeleteUid = uid;
            document.getElementById('confirm-delete-text').textContent =
                `Remove ${c.username} from your contacts?`;
            document.getElementById('confirm-delete-overlay').style.display = 'flex';
        };

        list.appendChild(div);
    });
}

document.getElementById('search-contacts').oninput = renderContactsList;

// ===================== ADD CONTACT =====================

let addContactMode = 'username'; // 'username' or 'email'

document.getElementById('mode-username').onclick = () => {
    addContactMode = 'username';
    document.getElementById('mode-username').style.cssText += ';background:var(--surface);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.3)';
    document.getElementById('mode-email').style.cssText += ';background:transparent;color:var(--text-dim);box-shadow:none';
    document.getElementById('contact-username-input').style.display = '';
    document.getElementById('contact-email-input').style.display = 'none';
    document.getElementById('search-mode-label').textContent = 'username';
    hideContactError();
};

document.getElementById('mode-email').onclick = () => {
    addContactMode = 'email';
    document.getElementById('mode-email').style.cssText += ';background:var(--surface);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.3)';
    document.getElementById('mode-username').style.cssText += ';background:transparent;color:var(--text-dim);box-shadow:none';
    document.getElementById('contact-email-input').style.display = '';
    document.getElementById('contact-username-input').style.display = 'none';
    document.getElementById('search-mode-label').textContent = 'email';
    hideContactError();
};

document.getElementById('add-contact-btn').onclick = () => {
    document.getElementById('add-contact-overlay').style.display = 'flex';
    document.getElementById('contact-username-input').value = '';
    document.getElementById('contact-email-input').value = '';
    hideContactError();
};

document.getElementById('cancel-add-contact').onclick = () => {
    document.getElementById('add-contact-overlay').style.display = 'none';
};

document.getElementById('confirm-add-contact').onclick = async () => {
    hideContactError();
    const btn = document.getElementById('confirm-add-contact');
    btn.disabled = true;
    btn.textContent = 'Searching...';

    try {
        let foundUid = null, foundData = null;

        if (addContactMode === 'username') {
            const raw = document.getElementById('contact-username-input').value.trim().replace(/^@/, '');
            if (!raw) { showContactError('Enter a username'); return; }
            const lower = raw.toLowerCase();
            if (lower === myUsername.toLowerCase()) { showContactError("That's your own username!"); return; }

            // Look up via usernameLookup index (O(1), no scan needed)
            const snap = await db.ref('usernameLookup/'+lower).once('value');
            if (!snap.exists()) { showContactError('No account found with that username'); return; }
            foundUid = snap.val();
            const profSnap = await db.ref('userProfiles/'+foundUid).once('value');
            foundData = profSnap.val() || {};

        } else {
            const email = document.getElementById('contact-email-input').value.trim().toLowerCase();
            if (!email) { showContactError('Enter an email'); return; }
            if (email === currentUser.email.toLowerCase()) { showContactError("That's your own email!"); return; }

            // Look up via emailLookup index (O(1), avoids orderByChild scan)
            const emailKey = email.replace(/\./g, '_');
            const snap = await db.ref('emailLookup/'+emailKey).once('value');
            if (!snap.exists()) { showContactError('No account found with that email'); return; }
            foundUid = snap.val();
            const profSnap = await db.ref('userProfiles/'+foundUid).once('value');
            foundData = profSnap.val() || {};
        }

        if (!foundUid || foundUid === myUid) { showContactError("That's your own account!"); return; }

        // Check not already a contact
        const existing = await db.ref('contacts/'+myUid+'/'+foundUid).once('value');
        if (existing.exists()) { showContactError('Already in your contacts!'); return; }

        // Add mutually
        await db.ref('contacts/'+myUid+'/'+foundUid).set(true);
        await db.ref('contacts/'+foundUid+'/'+myUid).set(true);

        document.getElementById('add-contact-overlay').style.display = 'none';
        showNotif('Added ' + (foundData.username || 'contact') + '!');

    } finally {
        btn.disabled = false;
        btn.textContent = 'Add Contact';
    }
};

// ===================== DELETE CONTACT =====================
// Handlers moved to event delegation block at bottom of file

// ===================== OPEN CHAT =====================

function openChat(uid, uname) {
    activeContactUid = uid;
    activeContactName = uname;

    // Sidebar mobile close
    document.getElementById('sidebar').classList.remove('mobile-open');
    document.getElementById('sidebar-backdrop').classList.remove('show');

    // Update toolbar
    document.getElementById('toolbar-avatar').style.display = 'flex';
    document.getElementById('toolbar-info').style.display = 'block';
    document.getElementById('toolbar-empty').style.display = 'none';
    document.getElementById('toolbar-name').textContent = uname;
    document.getElementById('toolbar-initials').textContent = getInitials(uname);
    document.getElementById('call-btn').style.display = 'flex';

    updateToolbarStatus();

    // Show messages area
    document.getElementById('main-content').style.display = 'none';
    document.getElementById('messages-area').style.display = 'flex';
    document.getElementById('input-area').style.display = 'block';

    // Load messages
    loadMessages(uid);
    listenTyping(uid);
    renderContactsList();
}

function updateToolbarStatus() {
    if (!activeContactUid || !contactsData[activeContactUid]) return;
    const c = contactsData[activeContactUid];
    const statusEl = document.getElementById('toolbar-status');
    statusEl.textContent = c.online ? 'Online' : 'Offline';
    statusEl.className = 'toolbar-status' + (c.online?' online':'');
}

// ===================== MESSAGES =====================

function getConvoId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
}

function loadMessages(contactUid) {
    const convoId = getConvoId(myUid, contactUid);
    const area = document.getElementById('messages-area');
    area.innerHTML = '';

    // Remove old listener
    if (msgListeners[convoId]) msgListeners[convoId]();

    const ref = db.ref('conversations/'+convoId+'/messages');

    // Auto-expire: clean on open and every 30s
    cleanExpiredMessages(convoId);
    const cleanInterval = setInterval(() => cleanExpiredMessages(convoId), 30000);

    ref.orderByChild('timestamp').limitToLast(100).on('child_added', snap => {
        const msg = snap.val();
        const now = Date.now();
        const age = now - msg.timestamp;
        const ttl = msg.ttl || 5 * 60 * 1000; // fallback 5 min
        if (age >= ttl) return; // Already expired, skip
        renderMessage(snap.key, msg);
        // Schedule visual removal
        const remaining = ttl - age;
        setTimeout(() => {
            const el = document.getElementById('msg-'+snap.key);
            if (el) {
                el.style.transition = 'opacity 0.4s, transform 0.4s';
                el.style.opacity = '0';
                el.style.transform = 'scale(0.9)';
                setTimeout(() => el.remove(), 400);
            }
        }, remaining);
    });

    // Listen for child_removed
    ref.on('child_removed', snap => {
        const el = document.getElementById('msg-'+snap.key);
        if (el) {
            el.style.transition = 'opacity 0.3s, transform 0.3s';
            el.style.opacity = '0';
            el.style.transform = 'scale(0.85)';
            setTimeout(() => el.remove(), 300);
        }
    });

    msgListeners[convoId] = () => { ref.off(); clearInterval(cleanInterval); };
}

async function cleanExpiredMessages(convoId) {
    // Each message has its own ttl stored, so we can't use a single cutoff.
    // We fetch recent messages and check individually.
    const snap = await db.ref('conversations/'+convoId+'/messages')
        .orderByChild('timestamp').limitToLast(200).once('value');
    if (!snap.exists()) return;
    const now = Date.now();
    const updates = {};
    snap.forEach(child => {
        const msg = child.val();
        const ttl = msg.ttl || 5 * 60 * 1000;
        if (now - msg.timestamp >= ttl) {
            updates[child.key] = null;
        }
    });
    if (Object.keys(updates).length > 0) {
        await db.ref('conversations/'+convoId+'/messages').update(updates);
    }
}

function renderMessage(key, msg) {
    const area = document.getElementById('messages-area');
    const isSent = msg.senderId === myUid;
    const now = Date.now();
    const age = now - msg.timestamp;
    const ttl = msg.ttl || 5 * 60 * 1000;
    const remaining = ttl - age;
    const remainSec = Math.max(0, Math.floor(remaining/1000));

    const row = document.createElement('div');
    row.className = 'msg-row ' + (isSent ? 'sent' : 'received');
    row.id = 'msg-'+key;

    const initials = getInitials(msg.senderName || '?');
    const timeStr = formatTime(msg.timestamp);

    // Build quote block if reply
    let quoteHtml = '';
    if (msg.replyTo) {
        quoteHtml = `<div class="msg-quote">
            <div class="msg-quote-author">${escHtml(msg.replyTo.senderName)}</div>
            <div class="msg-quote-text">${escHtml(msg.replyTo.text || 'üì∑ Image')}</div>
        </div>`;
    }

    let innerContent = quoteHtml;
    if (msg.imageData) {
        innerContent += `<img src="${msg.imageData}" class="msg-image" onclick="showImgPreview('${msg.imageData.replace(/'/g, "\\'")}')">`;
    }
    if (msg.text) {
        innerContent += `<div>${escHtml(msg.text)}</div>`;
    }

    const expireMin = Math.floor(remainSec / 60);
    const expireSec = remainSec % 60;
    const expireStr = `${expireMin}:${expireSec.toString().padStart(2,'0')}`;

    row.innerHTML = `
        ${!isSent ? `<div class="avatar" style="width:28px;height:28px;border-radius:9px"><span class="avatar-initials" style="font-size:11px">${initials}</span></div>` : ''}
        <div class="reply-icon">‚Ü©</div>
        <div class="msg-bubble">
            ${innerContent}
            <div class="msg-meta">
                <span class="msg-time">${timeStr}</span>
                <span class="msg-expires" style="font-size:10px;opacity:0.55;font-family:'Space Mono',monospace">‚è± ${expireStr}</span>
            </div>
            <div class="timer-bar" id="timerbar-${key}" style="width:${(remaining/ttl)*100}%"></div>
        </div>
        ${isSent ? `<div class="avatar" style="width:28px;height:28px;border-radius:9px"><span class="avatar-initials" style="font-size:11px">${getInitials(myUsername)}</span></div>` : ''}
    `;

    area.appendChild(row);
    area.scrollTop = area.scrollHeight;

    // Animate timer bar
    const bar = document.getElementById('timerbar-'+key);
    if (bar) {
        bar.style.transition = `width ${remaining}ms linear`;
        requestAnimationFrame(() => { bar.style.width = '0%'; });
    }

    // Live expire countdown
    const expEl = row.querySelector('.msg-expires');
    if (expEl) {
        const iv = setInterval(() => {
            const left = Math.max(0, ttl - (Date.now() - msg.timestamp));
            const m = Math.floor(left/60000), s = Math.floor((left%60000)/1000);
            expEl.textContent = '‚è± ' + m + ':' + String(s).padStart(2,'0');
            if (left <= 0) clearInterval(iv);
        }, 1000);
    }

    // Swipe to reply
    addSwipeToReply(row, key, msg);
}

function addSwipeToReply(row, key, msg) {
    const bubble = row.querySelector('.msg-bubble');
    const icon = row.querySelector('.reply-icon');
    const isSent = row.classList.contains('sent');
    let startX = 0, startY = 0, dx = 0;
    let swiping = false;
    const THRESHOLD = 60;

    function onStart(e) {
        const touch = e.touches ? e.touches[0] : e;
        startX = touch.clientX;
        startY = touch.clientY;
        dx = 0;
        swiping = true;
        bubble.style.transition = 'none';
    }

    function onMove(e) {
        if (!swiping) return;
        const touch = e.touches ? e.touches[0] : e;
        const diffX = touch.clientX - startX;
        const diffY = touch.clientY - startY;
        if (Math.abs(diffX) < Math.abs(diffY) && Math.abs(diffX) < 10) return;
        if (isSent && diffX > 0) return;
        if (!isSent && diffX < 0) return;
        dx = diffX;
        const maxDrag = THRESHOLD * 1.2;
        const clamped = Math.max(-maxDrag, Math.min(maxDrag, dx));
        bubble.style.transform = 'translateX(' + clamped + 'px)';
        const progress = Math.min(1, Math.abs(clamped) / THRESHOLD);
        icon.style.opacity = progress;
        icon.style.transform = 'translateY(-50%) scale(' + (0.6 + 0.4 * progress) + ')';
        if (progress >= 1) icon.classList.add('show'); else icon.classList.remove('show');
        if (e.cancelable) e.preventDefault();
    }

    function onEnd() {
        if (!swiping) return;
        swiping = false;
        bubble.style.transition = 'transform 0.25s ease';
        bubble.style.transform = '';
        icon.style.opacity = '0';
        icon.style.transform = 'translateY(-50%) scale(0.6)';
        icon.classList.remove('show');
        if (Math.abs(dx) >= THRESHOLD) triggerReply(key, msg);
    }

    row.addEventListener('touchstart', onStart, {passive: true});
    row.addEventListener('touchmove', onMove, {passive: false});
    row.addEventListener('touchend', onEnd);
    row.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', function(e) { if (swiping) onMove(e); });
    window.addEventListener('mouseup', function() { if (swiping) onEnd(); });
}

function triggerReply(key, msg) {
    replyingTo = {
        key,
        senderName: msg.senderName || 'Unknown',
        text: msg.text || (msg.imageData ? 'üì∑ Image' : '')
    };
    document.getElementById('reply-preview-label').textContent = 'Replying to ' + replyingTo.senderName;
    document.getElementById('reply-preview-body').textContent = replyingTo.text;
    document.getElementById('reply-preview').classList.add('show');
    document.getElementById('message-input').focus();
}
// Send message
document.getElementById('send-btn').onclick = sendMessage;
document.getElementById('message-input').onkeydown = e => { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} };

async function sendMessage() {
    if (!activeContactUid) return;
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    db.ref('typing/'+myUid).remove();
    clearTimeout(typingTimeout);

    const msgData = {
        senderId: myUid,
        senderName: myUsername,
        text,
        ttl: selectedTTL,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    if (replyingTo) {
        msgData.replyTo = {
            key: replyingTo.key,
            senderName: replyingTo.senderName,
            text: replyingTo.text
        };
        replyingTo = null;
        document.getElementById('reply-preview').classList.remove('show');
    }

    const convoId = getConvoId(myUid, activeContactUid);
    await db.ref('conversations/'+convoId+'/messages').push(msgData);
}

// Image upload
document.getElementById('attach-btn').onclick = () => document.getElementById('image-input').click();
document.getElementById('image-input').onchange = async e => {
    const file = e.target.files[0];
    if (!file || !activeContactUid) return;
    if (file.size > 500*1024) return alert('Image too large (max 500KB)');
    try {
        const base64 = await fileToBase64(file);
        const convoId = getConvoId(myUid, activeContactUid);
        await db.ref('conversations/'+convoId+'/messages').push({
            senderId: myUid,
            senderName: myUsername,
            imageData: base64,
            ttl: selectedTTL,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    } catch(err) { alert('Failed to upload image'); }
    e.target.value = '';
};

function fileToBase64(file) {
    return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
    });
}

// ===================== TYPING =====================

document.getElementById('message-input').oninput = () => {
    if (!activeContactUid) return;
    db.ref('typing/'+myUid).set({toUid: activeContactUid, username: myUsername});
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => db.ref('typing/'+myUid).remove(), 2000);
};

function listenTyping(contactUid) {
    db.ref('typing/'+contactUid).on('value', snap => {
        const d = snap.val();
        const bar = document.getElementById('typing-bar');
        if (d && d.toUid === myUid) {
            bar.textContent = (contactsData[contactUid]?.username || 'Someone') + ' is typing...';
        } else {
            bar.textContent = '';
        }
    });
}

// ===================== VOICE CALLS (WebRTC) =====================

const iceServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

document.getElementById('call-btn').onclick = () => startCall(activeContactUid);
document.getElementById('hangup-btn').onclick = hangup;
document.getElementById('decline-btn').onclick = declineCall;
document.getElementById('answer-btn').onclick = answerCall;
document.getElementById('mute-btn').onclick = toggleMute;

async function startCall(contactUid) {
    if (!contactUid) return;
    callContactUid = contactUid;
    callType = 'outgoing';

    try {
        localStream = await navigator.mediaDevices.getUserMedia({audio: true});
    } catch(e) {
        return alert('Microphone access denied. Please allow mic access to call.');
    }

    pc = new RTCPeerConnection(iceServers);
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.onicecandidate = e => {
        if (e.candidate) {
            db.ref('calls/'+contactUid+'/candidates/'+myUid).push(e.candidate.toJSON());
        }
    };

    pc.ontrack = e => {
        document.getElementById('remote-audio').srcObject = e.streams[0];
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // Signal the call
    await db.ref('calls/'+contactUid).set({
        from: myUid,
        fromName: myUsername,
        offer: {type: offer.type, sdp: offer.sdp},
        status: 'ringing',
        timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    // Show calling UI
    showCallUI('outgoing', activeContactName);

    // Listen for answer
    db.ref('calls/'+contactUid+'/answer').on('value', async snap => {
        if (snap.val() && pc && !pc.remoteDescription) {
            const answer = snap.val();
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
    });

    // Listen for ICE from other side
    db.ref('calls/'+myUid+'/candidates/'+contactUid).on('child_added', snap => {
        if (pc) pc.addIceCandidate(new RTCIceCandidate(snap.val()));
    });

    // Watch for call end
    db.ref('calls/'+contactUid+'/status').on('value', snap => {
        if (snap.val() === 'ended' || snap.val() === 'declined') {
            endCallUI('Call ended');
        }
    });
}

function listenForCalls() {
    db.ref('calls/'+myUid).on('value', async snap => {
        const call = snap.val();
        if (!call || call.status !== 'ringing') return;
        if (call.from === myUid) return;
        if (call.timestamp && Date.now() - call.timestamp > 60000) return; // Stale

        // Show incoming call
        callContactUid = call.from;
        callType = 'incoming';
        document.getElementById('incoming-name').textContent = call.fromName || 'Someone';
        document.getElementById('incoming-initials').textContent = getInitials(call.fromName || '?');
        document.getElementById('incoming-overlay').style.display = 'flex';

        // Store offer for when answered
        window._pendingCall = call;
    });
}

async function answerCall() {
    document.getElementById('incoming-overlay').style.display = 'none';
    const call = window._pendingCall;
    if (!call) return;

    try {
        localStream = await navigator.mediaDevices.getUserMedia({audio: true});
    } catch(e) {
        return alert('Microphone access denied.');
    }

    pc = new RTCPeerConnection(iceServers);
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.onicecandidate = e => {
        if (e.candidate) {
            db.ref('calls/'+myUid+'/candidates/'+myUid).push(e.candidate.toJSON());
        }
    };

    pc.ontrack = e => {
        document.getElementById('remote-audio').srcObject = e.streams[0];
    };

    await pc.setRemoteDescription(new RTCSessionDescription(call.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    // Send answer
    await db.ref('calls/'+myUid+'/answer').set({type: answer.type, sdp: answer.sdp});
    await db.ref('calls/'+myUid+'/status').set('answered');

    // Listen for caller's ICE
    db.ref('calls/'+myUid+'/candidates/'+call.from).on('child_added', snap => {
        if (pc) pc.addIceCandidate(new RTCIceCandidate(snap.val()));
    });

    const contactName = contactsData[call.from]?.username || call.fromName || 'Caller';
    showCallUI('incoming', contactName);

    // Watch for hangup
    db.ref('calls/'+myUid+'/status').on('value', snap => {
        if (snap.val() === 'ended') endCallUI('Call ended');
    });
}

function declineCall() {
    document.getElementById('incoming-overlay').style.display = 'none';
    if (window._pendingCall) {
        db.ref('calls/'+myUid+'/status').set('declined');
    }
    window._pendingCall = null;
}

function hangup() {
    if (callContactUid) {
        db.ref('calls/'+callContactUid+'/status').set('ended');
        db.ref('calls/'+myUid+'/status').set('ended');
    }
    endCallUI('Call ended');
}

function endCallUI(reason) {
    if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
    if (pc) { pc.close(); pc = null; }
    document.getElementById('call-overlay').classList.remove('active');
    document.getElementById('remote-audio').srcObject = null;
    callContactUid = null;
    db.ref('calls/'+myUid).off();
    showNotif(reason);
}

function showCallUI(type, name) {
    document.getElementById('call-overlay').classList.add('active');
    document.getElementById('call-name').textContent = name;
    document.getElementById('call-initials').textContent = getInitials(name);
    document.getElementById('call-status').textContent = type === 'outgoing' ? 'Calling...' : 'Connected';
    if (type === 'incoming') {
        setTimeout(() => {
            const s = document.getElementById('call-status');
            if (s) s.textContent = 'Connected';
        }, 100);
    }
}

function toggleMute() {
    isMuted = !isMuted;
    if (localStream) {
        localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
    }
    const btn = document.getElementById('mute-btn');
    btn.textContent = isMuted ? 'üîá' : 'üé§';
    btn.classList.toggle('active', isMuted);
}

// ===================== UI HELPERS =====================

document.getElementById('mobile-back').onclick = () => {
    document.getElementById('sidebar').classList.toggle('mobile-open');
    document.getElementById('sidebar-backdrop').classList.toggle('show');
};

document.getElementById('sidebar-backdrop').onclick = () => {
    document.getElementById('sidebar').classList.remove('mobile-open');
    document.getElementById('sidebar-backdrop').classList.remove('show');
};

document.getElementById('img-preview-close').onclick = () => {
    document.getElementById('img-preview').classList.remove('show');
};

window.showImgPreview = (src) => {
    document.getElementById('img-preview-src').src = src;
    document.getElementById('img-preview').classList.add('show');
};

function getInitials(name) {
    if (!name) return '?';
    return name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
}

function escHtml(t) {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}

function formatTime(ts) {
    if (!ts) return '';
    return new Date(ts).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
}

function showNotif(msg) {
    const n = document.createElement('div');
    n.className = 'notif';
    n.textContent = msg;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 3500);
}

function showAuthError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.classList.add('show');
}
function hideAuthError() { document.getElementById('auth-error').classList.remove('show'); }
function showContactError(msg) {
    const el = document.getElementById('contact-error');
    el.textContent = msg;
    el.classList.add('show');
}
function hideContactError() { document.getElementById('contact-error').classList.remove('show'); }

function firebaseErrMsg(code) {
    const m = {
        'auth/email-already-in-use': 'Email already in use',
        'auth/invalid-email': 'Invalid email',
        'auth/user-not-found': 'No account with that email',
        'auth/wrong-password': 'Wrong password',
        'auth/weak-password': 'Password too short',
        'auth/network-request-failed': 'Network error'
    };
    return m[code] || 'An error occurred';
}
</script>


<script>
// ‚îÄ‚îÄ Modal event delegation (runs after DOM is complete) ‚îÄ‚îÄ
document.addEventListener('click', function(e) {
    // Logout modal
    if (e.target.id === 'logout-cancel' || (e.target.closest && e.target.closest('#logout-cancel'))) {
        document.getElementById('logout-overlay').style.display = 'none';
    }
    if (e.target.id === 'logout-confirm' || (e.target.closest && e.target.closest('#logout-confirm'))) {
        document.getElementById('logout-overlay').style.display = 'none';
        auth.signOut();
    }
    // Delete contact modal
    if (e.target.id === 'confirm-delete-cancel' || (e.target.closest && e.target.closest('#confirm-delete-cancel'))) {
        document.getElementById('confirm-delete-overlay').style.display = 'none';
        pendingDeleteUid = null;
    }
    if (e.target.id === 'confirm-delete-ok' || (e.target.closest && e.target.closest('#confirm-delete-ok'))) {
        const uid = pendingDeleteUid;
        if (!uid) return;
        pendingDeleteUid = null;
        document.getElementById('confirm-delete-overlay').style.display = 'none';
        // Remove from both sides
        Promise.all([
            db.ref('contacts/'+myUid+'/'+uid).remove(),
            db.ref('contacts/'+uid+'/'+myUid).remove()
        ]).then(() => {
            // If this was the active chat, close it
            if (activeContactUid === uid) {
                activeContactUid = null;
                activeContactName = '';
                document.getElementById('toolbar-avatar').style.display = 'none';
                document.getElementById('toolbar-info').style.display = 'none';
                document.getElementById('toolbar-empty').style.display = '';
                document.getElementById('call-btn').style.display = 'none';
                document.getElementById('messages-area').style.display = 'none';
                document.getElementById('input-area').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
            }
            delete contactsData[uid];
            renderContactsList();
            showNotif('Contact removed');
        });
    }
    // Overlay backdrop clicks
    if (e.target.id === 'logout-overlay') {
        document.getElementById('logout-overlay').style.display = 'none';
    }
    if (e.target.id === 'confirm-delete-overlay') {
        document.getElementById('confirm-delete-overlay').style.display = 'none';
        pendingDeleteUid = null;
    }
});
</script>

<script>
// Mobile keyboard / viewport fix
// When virtual keyboard opens, shrink the layout to fit visual viewport
if (window.visualViewport) {
    function handleViewport() {
        const vv = window.visualViewport;
        // Set app height to actual visible area
        document.documentElement.style.setProperty('--app-height', vv.height + 'px');
    }
    window.visualViewport.addEventListener('resize', handleViewport);
    window.visualViewport.addEventListener('scroll', handleViewport);
    handleViewport();
}
</script>
</body>
</html>
